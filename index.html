<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Regulation Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- D3 + TopoJSON -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>

  <!-- jQuery + ScrollReveal -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/scrollreveal"></script>

  <style>
    :root {
      --bg: #0E1026;
      --panel-bg: #181a32;
      --accent: #4F46E5;
      --accent-soft: #a5b4fc;
      --border-subtle: rgba(255, 255, 255, 0.08);
      --text-primary: #f9fafb;
      --text-muted: #9ca3af;
      --chip-bg: rgba(79, 70, 229, 0.16);
      --chip-border: rgba(129, 140, 248, 0.5);
      --badge-bg: rgba(248, 250, 252, 0.05);
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: #020617; /* matches underside of dark gradient */
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #020617 100%);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 1.5rem;
      gap: 1.5rem;
    }

    /* --- HEADERS, MAP, PANELS, TIMELINE, ETC --- */
    /* (Everything below remains unchanged from your version except federal JSON integration) */

    .page-header {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1rem 1.25rem 0.5rem;
    }

    .page-title {
      font-size: 1.8rem;
      margin: 0 0 0.25rem;
      display: flex;
      gap: .5rem;
      align-items: center;
    }

    .badge {
      font-size: .65rem;
      padding: .2rem .45rem;
      border-radius: 999px;
      background: var(--badge-bg);
      border: 1px solid var(--border-subtle);
      text-transform: uppercase;
      letter-spacing: .12em;
    }

    .page-subtitle {
      color: var(--text-muted);
      font-size: .9rem;
      margin: 0;
    }

    .layout {
      flex: 1;
      max-width: 1100px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1.6fr 1.4fr;
      gap: 1.25rem;
    }

    @media(max-width:900px){
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #181a32;
      border-radius: 1rem;
      padding: 1rem;
      border: 1px solid var(--border-subtle);
    }

    #us-map {
      width: 100%;
      height: auto;
      display: block;
    }

    #us-map path {
      fill: #1f2937;
      stroke: #111827;
      transition: .2s ease;
    }

    #us-map path[data-has-ai="true"] { fill: #4f46e5; }
    #us-map path[data-selected="true"] {
      fill: #a5b4fc;
      stroke: #e5e7eb;
      stroke-width: 2;
    }

    #us-map path:hover {
      cursor: pointer;
      transform: translateY(-1px);
      stroke-width: 1.5;
      stroke: #d1d5db;
    }

    .state-panel-scroll {
      overflow-y: auto;
      max-height: 480px;
      padding-right: .5rem;
    }

    .state-timeline {
      border-left: 1px solid rgba(148,163,184,0.5);
      padding-left: .7rem;
      margin-left: .3rem;
    }

    .state-event { margin-bottom: 1rem; position: relative; }
    .state-event:before {
      content: "";
      position: absolute;
      left: -1rem;
      top: 6px;
      width: .45rem;
      height: .45rem;
      border-radius: 50%;
      background: var(--accent-soft);
    }

    /* --- Federal timeline (unchanged styling) --- */

    .timeline { position: relative; }
    .timeline:before {
      content:"";
      position:absolute;
      left:50%;
      top:0;
      width:3px;
      height:100%;
      background:rgba(148,163,184,0.4);
      transform:translateX(-50%);
    }

    .timeline-item { display:flex; justify-content:flex-end; padding:1rem 0; }
    .timeline-item:nth-child(odd){ justify-content:flex-start; }

    .timeline-content {
      background:#181a32;
      border:1px solid var(--border-subtle);
      border-radius:.75rem;
      padding:.9rem 1rem;
      width:46%;
      position:relative;
    }

    .timeline-content:before {
      content:"";
      position:absolute;
      top:1rem;
      width:.55rem;
      height:.55rem;
      border-radius:50%;
      background:var(--accent-soft);
      box-shadow:0 0 0 4px rgba(129,140,248,0.35);
    }

    .timeline-item:nth-child(even) .timeline-content:before { right:-.3rem; }
    .timeline-item:nth-child(odd) .timeline-content:before { left:-.3rem; }
  </style>
</head>

<body>
<div class="page">

  <header class="page-header">
    <h1 class="page-title">AI Regulation Map <span class="badge">Prototype</span></h1>
    <p class="page-subtitle">Click a state to view its AI-related bills and policy activity. Data loads from JSON files for easy updates.</p>
  </header>

  <main class="layout">

    <!-- MAP PANEL -->
    <section class="card">
      <h2>US States</h2>
      <p class="text-muted">Highlighted states have at least one AI-related entry.</p>
      <svg id="us-map"></svg>
    </section>

    <!-- STATE DETAILS -->
    <section class="card">
      <h2>State Timeline</h2>

      <div id="details-placeholder" class="state-panel-scroll">
        <p class="placeholder">Click a highlighted state to load its AI timeline.</p>
      </div>

      <div id="details-content" class="state-panel-scroll" style="display:none;"></div>
    </section>

  </main>

  <!-- FEDERAL TIMELINE -->
  <section class="card" style="max-width:1100px; margin:0 auto;">
    <h2>Federal AI Regulation Timeline</h2>
    <div id="federal-timeline-root"></div>
  </section>

</div>

<script>
/* ============================================================
   LOAD STATE DATA FROM JSON
============================================================ */
let STATE_DATA = {};

async function loadStateData() {
  const res = await fetch("state-ai-legislation.json");
  const data = await res.json();
  Object.values(data).forEach(s => {
    if (s.events) s.events.sort((a,b)=>new Date(a.date)-new Date(b.date));
  });
  STATE_DATA = data;
}

/* ============================================================
   LOAD FEDERAL DATA FROM JSON
============================================================ */
let FEDERAL_AI_EVENTS = [];

async function loadFederalData() {
  const res = await fetch("federal-ai-events.json");
  const data = await res.json();
  data.sort((a,b)=>new Date(a.date)-new Date(b.date));
  FEDERAL_AI_EVENTS = data;
}

/* ============================================================
   MAP RENDERING
============================================================ */

const FIPS_TO_ABBR = {
  "01":"AL","02":"AK","04":"AZ","05":"AR","06":"CA","08":"CO","09":"CT",
  "10":"DE","11":"DC","12":"FL","13":"GA","15":"HI","16":"ID","17":"IL",
  "18":"IN","19":"IA","20":"KS","21":"KY","22":"LA","23":"ME","24":"MD",
  "25":"MA","26":"MI","27":"MN","28":"MS","29":"MO","30":"MT","31":"NE",
  "32":"NV","33":"NH","34":"NJ","35":"NM","36":"NY","37":"NC","38":"ND",
  "39":"OH","40":"OK","41":"OR","42":"PA","44":"RI","45":"SC","46":"SD",
  "47":"TN","48":"TX","49":"UT","50":"VT","51":"VA","53":"WA","54":"WV",
  "55":"WI","56":"WY"
};

const svg = d3.select("#us-map")
  .attr("viewBox","0 0 960 600")
  .attr("preserveAspectRatio","xMidYMid meet");

const projection = d3.geoAlbersUsa().scale(1280).translate([480, 300]);
const path = d3.geoPath(projection);

async function drawMap() {
  await loadStateData();
  const us = await d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json");
  const states = topojson.feature(us, us.objects.states).features;

  const paths = svg.selectAll("path")
    .data(states)
    .join("path")
    .attr("d", path)
    .attr("data-abbr", d => FIPS_TO_ABBR[d.id])
    .attr("data-has-ai", d => STATE_DATA[FIPS_TO_ABBR[d.id]] ? "true" : null);

  paths
    .attr("fill", d => STATE_DATA[FIPS_TO_ABBR[d.id]] ? "#4f46e5" : "#1f2937")
    .attr("stroke", "#111827")
    .attr("stroke-width", .8)
    .on("click", function(e, d){
      const abbr = FIPS_TO_ABBR[d.id];
      svg.selectAll("path").attr("data-selected", null);
      d3.select(this).attr("data-selected","true");
      renderStateDetails(abbr);
    });
}

/* ============================================================
   STATE PANEL
============================================================ */
function renderStateDetails(abbr){
  const placeholder = document.getElementById("details-placeholder");
  const panel = document.getElementById("details-content");

  placeholder.style.display = "none";
  panel.style.display = "block";

  const data = STATE_DATA[abbr];
  if (!data) {
    panel.innerHTML = `<p>No AI data for ${abbr}.</p>`;
    return;
  }

  const html = data.events.map(ev => `
    <div class="state-event">
      <div class="state-event-date">${new Date(ev.date).toLocaleDateString()}</div>
      <h4>${ev.title}</h4>
      <div><span>${ev.status}</span></div>
      <p>${ev.summary}</p>
      ${(ev.links||[]).map(l=>`<a href="${l.url}" target="_blank">${l.label}</a>`).join("")}
    </div>
  `).join("");

  panel.innerHTML = `
    <h3>${data.name} (${abbr})</h3>
    <div class="state-timeline">${html}</div>
  `;
}

/* ============================================================
   FEDERAL TIMELINE RENDERING
============================================================ */
function renderFederalTimeline(){
  const root = document.getElementById("federal-timeline-root");
  if (!FEDERAL_AI_EVENTS.length){
    root.innerHTML = "<p>No federal events found.</p>";
    return;
  }

  root.innerHTML = `
    <div class="timeline">
      ${FEDERAL_AI_EVENTS.map(ev => `
      <div class="timeline-item js--fadeInRight">
        <div class="timeline-content">
          <span class="timeline-date">${new Date(ev.date).toLocaleDateString()}</span>
          <h3>${ev.title}</h3>
          <div class="timeline-status">${ev.status}</div>
          <p class="timeline-summary">${ev.summary}</p>
        </div>
      </div>`).join("")}
    </div>
  `;
}

/* ============================================================
   PAGE LOAD
============================================================ */

Promise.all([
  drawMap(),
  loadFederalData()
]).then(renderFederalTimeline);

</script>

</body>
</html>
